<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FocusFlow Sovereign Elite ¬∑ PWA + PDF</title>

    <!-- PWA / Manifest (icons & meta) -->
    <link rel="icon" type="image/png" href="1.png">
    <link rel="apple-touch-icon" href="1.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" id="manifest">

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <!-- jsPDF + autoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --bg: #000000;
            --card-bg: #111827;
            --accent: #38bdf8;
            --text-main: #f8fafc;
            --text-dim: #64748b;
            --college: #2dd4bf;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body {
            background-color: var(--bg);
            background-image: radial-gradient(circle at 50% -10%, #1e293b 0%, #000 80%);
            color: var(--text-main);
            font-family: 'Plus Jakarta Sans', sans-serif;
            margin: 0; padding: 15px;
            min-height: 100vh;
            overflow-x: hidden;
        }
        header { 
            position: sticky; top: 0; background: rgba(0,0,0,0.85); 
            backdrop-filter: blur(15px); z-index: 100; padding: 10px 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .streak-badge {
            background: linear-gradient(45deg, #f59e0b, #ef4444);
            padding: 6px 14px; border-radius: 20px; font-weight: 800; font-size: 0.7rem;
        }
        .month-scroller {
            display: flex; gap: 8px; overflow-x: auto;
            padding: 10px 0 20px 0; scrollbar-width: none;
        }
        .month-scroller::-webkit-scrollbar { display: none; }
        .month-btn {
            padding: 8px 18px; background: #1f2937;
            border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);
            color: var(--text-dim); white-space: nowrap; font-size: 0.85rem;
            transition: 0.3s; cursor: pointer;
        }
        .month-btn.active { background: var(--accent); color: #000; font-weight: 800; }
        .days-list { 
            display: flex; flex-direction: column; gap: 12px; padding-bottom: 80px;
            transition: opacity 0.25s ease-in-out;
            opacity: 1;
        }
        .days-list.fade-out { opacity: 0; }
        .day-card {
            background: var(--card-bg); border-radius: 24px; padding: 20px;
            display: flex; align-items: center; border: 1px solid rgba(255,255,255,0.05);
            transition: 0.3s; position: relative; cursor: pointer;
        }
        .day-card.is-today { border: 2px solid var(--accent); background: #0f172a; }
        .chart-container { width: 65px; height: 65px; position: relative; margin-left: 10px; }
        .chart-svg { transform: rotate(-90deg); border-radius: 50%; width: 100%; height: 100%; }
        .percentage-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 800; }
        #modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            display: none; justify-content: center; align-items: flex-end; z-index: 1000;
        }
        .modal-content {
            background: #0f172a; width: 100%; max-width: 500px;
            border-radius: 30px 30px 0 0; padding: 25px;
            animation: sheetUp 0.3s ease-out; max-height: 85vh; overflow-y: auto;
        }
        @keyframes sheetUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        #todayFab {
            position: fixed; bottom: 25px; right: 25px;
            width: 50px; height: 50px; background: var(--accent);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 25px rgba(56, 189, 248, 0.4);
            z-index: 99; border: none; font-size: 1.2rem; cursor: pointer;
            animation: bounce 2s infinite;
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .input-layout { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .input-item-full { grid-column: span 2; background: rgba(45, 212, 191, 0.08); border: 1px solid rgba(45, 212, 191, 0.2); padding: 15px; border-radius: 18px; }
        .input-item-compact { background: rgba(255, 255, 255, 0.03); padding: 12px; border-radius: 18px; border: 1px solid rgba(255, 255, 255, 0.08); }
        .input-label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        label { font-size: 0.65rem; font-weight: 800; color: var(--text-dim); text-transform: uppercase; }
        .limit-tag { font-size: 0.6rem; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; color: var(--accent); }
        input { width: 100%; background: transparent; border: none; color: #fff; font-size: 1.4rem; font-weight: 800; padding: 5px 0; }
        input:disabled { opacity: 0.4; color: #aaa; }
        .mini-progress { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 8px; overflow: hidden; }
        .mini-fill { height: 100%; transition: width 0.5s ease; }
        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
        .stat-card { background: #1e293b; padding: 15px; border-radius: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .stat-card b { display: block; font-size: 1.3rem; color: var(--accent); }
        .stat-card span { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; }
        .btn-save { width: 100%; padding: 16px; border-radius: 18px; border: none; background: var(--accent); color: #000; font-weight: 800; font-size: 1rem; margin-top: 20px; cursor: pointer; }
        .btn-pdf { background: #8b5cf6; color: white; margin-left: 10px; }
        .subject-row { display: flex; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 12px; margin-bottom: 8px; font-size: 0.85rem; }
        .modal-actions { display: flex; gap: 10px; margin-top: 15px; }
        .modal-actions button { flex: 1; }

        /* offline banner */
        #offlineBanner {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff3b3b;
            color: #fff;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 13px;
            display: none;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <!-- offline banner (hidden by default) -->
    <div id="offlineBanner">üì° You are offline</div>

    <header>
        <div>
            <h1 style="margin:0; font-size:1.4rem; color:var(--accent)">FocusFlow</h1>
            <p style="margin:0; font-size:0.6rem; letter-spacing:1px; color:var(--text-dim)">SOVEREIGN ELITE ¬∑ PWA</p>
        </div>
        <div class="streak-badge" id="streakDisplay">üî• 0 STREAK</div>
    </header>

    <div class="month-scroller" id="monthTabs"></div>
    <div class="days-list" id="daysGrid"></div>

    <button id="todayFab" onclick="scrollToToday()">üìå</button>

    <div id="modal" onclick="handleOutsideClick(event)">
        <div class="modal-content" id="modalBody" onclick="event.stopPropagation()"></div>
    </div>

<script>
    (function() {
        // ----- CONFIG -----
        const CONFIG = {
            COLLEGE: { goal: 180, color: '#2dd4bf' },
            MATH: { goal: 120, color: '#f87171' },
            ENGLISH: { goal: 60, color: '#fbbf24' },
            REASONING: { goal: 60, color: '#c084fc' },
            GK: { goal: 120, color: '#60a5fa' }
        };
        const TOTAL_GOAL = 540;
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        
        let db = JSON.parse(localStorage.getItem('FF_Sovereign_V4')) || {};
        let currentMonthView = new Date().getMonth();

        function getTodayKey() {
            let d = new Date();
            return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
        }

        function isFutureDay(year, month, day) {
            let d = new Date(year, month, day);
            let today = new Date();
            today.setHours(0,0,0,0);
            return d > today;
        }

        function isPastDay(year, month, day) {
            let d = new Date(year, month, day);
            let today = new Date();
            today.setHours(0,0,0,0);
            return d < today;
        }

        function renderMonths() {
            document.getElementById('monthTabs').innerHTML = months.map((m, i) => `
                <div class="month-btn ${i === currentMonthView ? 'active' : ''}" onclick="onMonthClick(${i})">${m}</div>
            `).join('');
        }

        window.onMonthClick = function(i) {
            if (i === currentMonthView) {
                showMonthOverview(i);
                return;
            }
            const grid = document.getElementById('daysGrid');
            grid.classList.add('fade-out');
            setTimeout(() => {
                currentMonthView = i;
                renderMonths();
                renderDays(i, false);
                grid.classList.remove('fade-out');
            }, 200);
        };

        function renderDays(mIdx, scrollToTodayFlag) {
            const grid = document.getElementById('daysGrid'); 
            grid.innerHTML = '';
            const now = new Date(); 
            const year = now.getFullYear();
            const days = new Date(year, mIdx + 1, 0).getDate();

            for (let i = 1; i <= days; i++) {
                const key = `${year}-${mIdx}-${i}`;
                const data = db[key] || { COLLEGE:0, MATH:0, ENGLISH:0, REASONING:0, GK:0 };
                const total = Object.values(data).reduce((a,b)=>a+b, 0);
                const percent = Math.min(Math.round((total/TOTAL_GOAL)*100), 100);
                const dObj = new Date(year, mIdx, i);
                const isToday = dObj.toDateString() === now.toDateString();
                
                const card = document.createElement('div');
                card.className = `day-card ${isToday ? 'is-today' : ''}`;
                if(isToday) card.id = 'today-focus';

                let lockLabel = '';
                if (isPastDay(year, mIdx, i) && !isToday) lockLabel = '‚Ä¢ PAST';
                else if (isFutureDay(year, mIdx, i) && !isToday) lockLabel = '‚Ä¢ FUTURE';

                card.innerHTML = `
                    <div class="card-left">
                        <p>${months[mIdx]} ${i} ${lockLabel}</p>
                        <h3 style="color:${percent >= 75 ? '#2dd4bf' : (percent >= 40 ? '#fbbf24' : '#f87171')}">${percent}% Complete</h3>
                        <p>${total} / 540m</p>
                    </div>
                    <div class="chart-container">
                        ${createPieSVG(data, total)}
                        <div class="percentage-overlay">${percent}%</div>
                    </div>
                `;
                card.onclick = () => openInputModal(key, i, months[mIdx], isToday, dObj);
                grid.appendChild(card);
            }
            if (scrollToTodayFlag) scrollToToday();
            initSwipe();
        }

        function createPieSVG(data, total) {
            if(total === 0) return `<svg class="chart-svg" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="#1f2937"/></svg>`;
            let cumulative = 0; const slices = [];
            for (let s in CONFIG) {
                const p = (data[s] / total) * 100;
                if (p <= 0) continue;
                slices.push(`<circle cx="16" cy="16" r="16" fill="transparent" stroke="${CONFIG[s].color}" stroke-width="32" stroke-dasharray="${p} ${100-p}" stroke-dashoffset="-${cumulative}" />`);
                cumulative += p;
            }
            return `<svg class="chart-svg" viewBox="0 0 32 32">${slices.join('')}</svg>`;
        }

        window.openInputModal = function(key, day, mon, isToday, dateObj) {
            const data = db[key] || { COLLEGE:0, MATH:0, ENGLISH:0, REASONING:0, GK:0 };
            const year = dateObj.getFullYear();
            const isLocked = (isPastDay(year, dateObj.getMonth(), day) && !isToday) || (isFutureDay(year, dateObj.getMonth(), day) && !isToday);
            
            let html = `
                <h2 style="margin:0">${day} ${mon}</h2>
                <p style="color:var(--text-dim); font-size:0.8rem; margin-bottom:15px">${isLocked ? 'üîí View only' : '‚úèÔ∏è Daily Entry'}</p>
                <div class="input-item-full">
                    <div class="input-label-row"><label>College</label><span class="limit-tag">Target: 180m</span></div>
                    <input type="number" id="in-COLLEGE" value="${data.COLLEGE}" ${isLocked?'disabled':''} min="0" step="1">
                    <div class="mini-progress"><div class="mini-fill" style="width:${(data.COLLEGE/180)*100}%; background:${CONFIG.COLLEGE.color}"></div></div>
                </div>
                <div class="input-layout">`;

            ['MATH', 'ENGLISH', 'REASONING', 'GK'].forEach(s => {
                const p = (data[s] / CONFIG[s].goal) * 100;
                html += `
                    <div class="input-item-compact">
                        <div class="input-label-row"><label>${s}</label><span class="limit-tag">${CONFIG[s].goal}m</span></div>
                        <input type="number" id="in-${s}" value="${data[s]}" ${isLocked?'disabled':''} min="0" step="1">
                        <div class="mini-progress"><div class="mini-fill" style="width:${p}%; background:${CONFIG[s].color}"></div></div>
                    </div>`;
            });

            html += `</div>`;
            if(!isLocked) html += `<button class="btn-save" onclick="saveEntry('${key}')">Confirm Session</button>`;
            else html += `<div style="height:10px"></div>`;
            html += `<button onclick="closeModal()" style="width:100%; background:none; border:none; color:var(--text-dim); margin:15px 0; font-weight:700">Dismiss</button>`;
            
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('modal').style.display = 'flex';
        };

        window.saveEntry = function(key) {
            const newData = {}; let total = 0;
            for (let s in CONFIG) { 
                let val = parseInt(document.getElementById(`in-${s}`).value) || 0; 
                if (val < 0) val = 0;
                newData[s] = val; 
                total += val; 
            }
            db[key] = newData; 
            localStorage.setItem('FF_Sovereign_V4', JSON.stringify(db));
            if(total >= TOTAL_GOAL) confetti({ particleCount: 150, spread: 70, origin: { y: 0.7 }, colors: ['#38bdf8', '#2dd4bf', '#ffffff'] });
            updateStreak(); 
            closeModal(); 
            renderDays(currentMonthView, false);
        };

        window.showMonthOverview = function(mIdx) {
            const year = new Date().getFullYear();
            const daysInMonth = new Date(year, mIdx + 1, 0).getDate();
            let stats = { totalMins: 0, active: 0, skipped: 0, subs: { COLLEGE:0, MATH:0, ENGLISH:0, REASONING:0, GK:0 } };

            for(let i=1; i<=daysInMonth; i++) {
                const data = db[`${year}-${mIdx}-${i}`];
                if(data) {
                    const daySum = Object.values(data).reduce((a,b)=>a+b,0);
                    if(daySum > 0) { 
                        stats.active++; 
                        stats.totalMins += daySum; 
                        for(let s in CONFIG) stats.subs[s] += (data[s] || 0); 
                    } else stats.skipped++;
                } else stats.skipped++;
            }

            const efficiency = Math.round((stats.totalMins / (TOTAL_GOAL * daysInMonth)) * 100) || 0;
            const pieCanvasId = 'monthPieCanvas';
            let html = `
                <h2 style="margin:0">${months[mIdx]} Analytics</h2>
                <div class="analytics-grid">
                    <div class="stat-card"><b>${stats.active}</b><span>Days Active</span></div>
                    <div class="stat-card"><b>${efficiency}%</b><span>Efficiency</span></div>
                    <div class="stat-card"><b>${Math.floor(stats.totalMins/60)}h ${stats.totalMins%60}m</b><span>Study Time</span></div>
                    <div class="stat-card"><b>${stats.skipped}</b><span>Skipped</span></div>
                </div>
                <div style="display:flex; justify-content:center; margin:15px 0;">
                    <canvas id="${pieCanvasId}" width="160" height="160" style="width:160px; height:160px;"></canvas>
                </div>
                <h3 style="font-size:0.9rem; margin-bottom:10px;">üìä Subject totals</h3>`;

            for(let s in CONFIG) {
                html += `<div class="subject-row"><span style="border-left:4px solid ${CONFIG[s].color}; padding-left:8px;">${s}</span><b>${Math.floor(stats.subs[s]/60)}h ${stats.subs[s]%60}m</b></div>`;
            }

            html += `<div class="modal-actions">
                        <button class="btn-save" onclick="closeModal()">Return</button>
                        <button class="btn-save btn-pdf" onclick="generateMonthPDF(${mIdx})">üìÑ PDF Report</button>
                     </div>`;
            
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('modal').style.display = 'flex';

            requestAnimationFrame(() => {
                const canvas = document.getElementById(pieCanvasId);
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const total = stats.totalMins || 1;
                let startAngle = -Math.PI / 2;
                const centerX = 80, centerY = 80, radius = 70;
                for (let s in CONFIG) {
                    const value = stats.subs[s] || 0;
                    if (value === 0) continue;
                    const sliceAngle = (value / total) * 2 * Math.PI;
                    ctx.beginPath();
                    ctx.fillStyle = CONFIG[s].color;
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
                    ctx.closePath();
                    ctx.fill();
                    startAngle += sliceAngle;
                }
                if (total === 0) {
                    ctx.fillStyle = '#1f2937';
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                    ctx.fill();
                }
            });

            if(efficiency >= 75) confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
        };

        window.generateMonthPDF = function(mIdx) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
            const year = new Date().getFullYear();
            const monthName = months[mIdx];
            const daysInMonth = new Date(year, mIdx + 1, 0).getDate();

            let rows = [];
            let monthTotal = 0;
            let subTotals = { COLLEGE:0, MATH:0, ENGLISH:0, REASONING:0, GK:0 };

            for (let i = 1; i <= daysInMonth; i++) {
                const key = `${year}-${mIdx}-${i}`;
                const data = db[key] || { COLLEGE:0, MATH:0, ENGLISH:0, REASONING:0, GK:0 };
                const c = data.COLLEGE || 0;
                const m = data.MATH || 0;
                const e = data.ENGLISH || 0;
                const r = data.REASONING || 0;
                const g = data.GK || 0;
                const dayTotal = c + m + e + r + g;
                monthTotal += dayTotal;
                subTotals.COLLEGE += c; subTotals.MATH += m; subTotals.ENGLISH += e; subTotals.REASONING += r; subTotals.GK += g;
                const dayStr = `${i} ${monthName}`;
                const pct = Math.min(Math.round((dayTotal/TOTAL_GOAL)*100), 100);
                rows.push([ dayStr, c, m, e, r, g, dayTotal, pct + '%' ]);
            }

            const avgPct = Math.min(Math.round((monthTotal / (TOTAL_GOAL * daysInMonth)) * 100), 100);
            rows.push([ 
                { content: 'TOTAL', colSpan: 1, styles: { fillColor: '#1e293b', textColor: '#ffffff', fontStyle: 'bold' } },
                subTotals.COLLEGE, subTotals.MATH, subTotals.ENGLISH, subTotals.REASONING, subTotals.GK, 
                monthTotal, avgPct + '%' 
            ]);

            doc.setFont('helvetica', 'normal');
            doc.setTextColor('#f8fafc');
            doc.setFillColor('#000000');
            doc.rect(0, 0, doc.internal.pageSize.width, 60, 'F');
            doc.setFontSize(20);
            doc.setTextColor('#38bdf8');
            doc.text(`FocusFlow ¬∑ ${monthName} ${year}`, 40, 40);
            
            doc.autoTable({
                startY: 180,
                head: [['Day', 'College', 'Math', 'English', 'Reason', 'GK', 'Total', '%']],
                body: rows,
                theme: 'grid',
                styles: { font: 'helvetica', fontSize: 9, textColor: '#f1f5f9', lineColor: '#334155', lineWidth: 0.5, fillColor: '#1f2937' },
                headStyles: { fillColor: '#0f172a', textColor: '#38bdf8', fontStyle: 'bold' },
                alternateRowStyles: { fillColor: '#2d3748' },
                columnStyles: {
                    0: { cellWidth: 65 },
                    1: { halign: 'right', textColor: '#2dd4bf' },
                    2: { halign: 'right', textColor: '#f87171' },
                    3: { halign: 'right', textColor: '#fbbf24' },
                    4: { halign: 'right', textColor: '#c084fc' },
                    5: { halign: 'right', textColor: '#60a5fa' },
                    6: { halign: 'right', fontStyle: 'bold', textColor: '#ffffff' },
                    7: { halign: 'center', fontStyle: 'bold' }
                },
                didParseCell: (data) => {
                    if (data.row.index === rows.length-1) {
                        data.cell.styles.fillColor = '#1e293b';
                        data.cell.styles.fontStyle = 'bold';
                        if (data.column.index === 1) data.cell.styles.textColor = '#2dd4bf';
                        if (data.column.index === 2) data.cell.styles.textColor = '#f87171';
                        if (data.column.index === 3) data.cell.styles.textColor = '#fbbf24';
                        if (data.column.index === 4) data.cell.styles.textColor = '#c084fc';
                        if (data.column.index === 5) data.cell.styles.textColor = '#60a5fa';
                        if (data.column.index === 6) data.cell.styles.textColor = '#ffffff';
                    }
                }
            });

            const finalY = doc.lastAutoTable.finalY || 400;
            doc.setFontSize(10);
            doc.setTextColor('#94a3b8');
            doc.text(`Report generated ¬∑ streak: ${document.getElementById('streakDisplay').innerText} ¬∑ sovereign elite v4`, 40, finalY + 30);
            doc.save(`FocusFlow_${monthName}_${year}.pdf`);
            confetti({ particleCount: 80, spread: 50, origin: { y: 0.5 } });
        };

        window.updateStreak = function() {
            let streak = 0; let d = new Date();
            while(true) {
                let key = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
                if(db[key] && Object.values(db[key]).reduce((a,b)=>a+b,0) >= (TOTAL_GOAL * 0.5)) { streak++; d.setDate(d.getDate()-1); } else break;
            }
            document.getElementById('streakDisplay').innerText = `üî• ${streak} DAY STREAK`;
        };

        window.handleOutsideClick = function(e) { if(e.target.id === 'modal') closeModal(); };
        window.closeModal = function() { document.getElementById('modal').style.display = 'none'; };
        window.scrollToToday = function() {
            const now = new Date();
            if (currentMonthView !== now.getMonth()) {
                const grid = document.getElementById('daysGrid');
                grid.classList.add('fade-out');
                setTimeout(() => {
                    currentMonthView = now.getMonth();
                    renderMonths();
                    renderDays(currentMonthView, false);
                    grid.classList.remove('fade-out');
                    setTimeout(() => document.getElementById('today-focus')?.scrollIntoView({behavior:'smooth', block:'center'}), 50);
                }, 200);
            } else {
                setTimeout(() => document.getElementById('today-focus')?.scrollIntoView({behavior:'smooth', block:'center'}), 100);
            }
        };

        let swipeHandler = null;
        function initSwipe() {
            const grid = document.getElementById('daysGrid');
            if (!grid) return;
            if (swipeHandler) {
                grid.removeEventListener('touchstart', swipeHandler);
                grid.removeEventListener('touchend', swipeHandler);
            }
            let startX, startY;
            swipeHandler = function(e) {
                if (e.type === 'touchstart') {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                } else if (e.type === 'touchend') {
                    if (startX === undefined) return;
                    const endX = e.changedTouches[0].clientX;
                    const endY = e.changedTouches[0].clientY;
                    const deltaX = endX - startX;
                    const deltaY = endY - startY;
                    if (Math.abs(deltaX) > 50 && Math.abs(deltaY) < 30) {
                        let newMonth;
                        if (deltaX > 0) {
                            newMonth = currentMonthView - 1;
                            if (newMonth < 0) newMonth = 11;
                        } else {
                            newMonth = currentMonthView + 1;
                            if (newMonth > 11) newMonth = 0;
                        }
                        if (newMonth !== currentMonthView) {
                            const grid = document.getElementById('daysGrid');
                            grid.classList.add('fade-out');
                            setTimeout(() => {
                                currentMonthView = newMonth;
                                renderMonths();
                                renderDays(currentMonthView, false);
                                grid.classList.remove('fade-out');
                            }, 200);
                        }
                    }
                    startX = undefined;
                }
            };
            grid.addEventListener('touchstart', swipeHandler);
            grid.addEventListener('touchend', swipeHandler);
        }

        // ----- PWA: Manifest + Service Worker + Offline Banner -----
        function setupPWA() {
            // 1. manifest (inline blob)
            const manifest = {
                name: "FocusFlow Sovereign Elite",
                short_name: "FocusFlow",
                start_url: ".",
                display: "standalone",
                background_color: "#000000",
                theme_color: "#38bdf8",
                icons: [
                    { src: "1.png", sizes: "192x192", type: "image/png", purpose: "any maskable" },
                    { src: "1.png", sizes: "512x512", type: "image/png" }
                ]
            };
            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            document.getElementById('manifest').href = URL.createObjectURL(manifestBlob);

            // 2. service worker (inline via blob)
            if ('serviceWorker' in navigator) {
                const swCode = `
                    self.addEventListener('install', e => {
                        e.waitUntil(
                            caches.open('focusflow-v1').then(cache => 
                                cache.addAll(['./', './1.png'])
                            )
                        );
                    });
                    self.addEventListener('fetch', e => {
                        e.respondWith(
                            caches.match(e.request).then(response => response || fetch(e.request))
                        );
                    });
                `;
                const swBlob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(swBlob);
                navigator.serviceWorker.register(swUrl).then(reg => {
                    console.log('SW registered:', reg);
                }).catch(err => console.error('SW registration failed:', err));
            }

            // 3. offline banner
            const banner = document.getElementById('offlineBanner');
            window.addEventListener('offline', () => banner.style.display = 'block');
            window.addEventListener('online', () => banner.style.display = 'none');
            if (!navigator.onLine) banner.style.display = 'block';
        }

        window.onload = function() {
            renderMonths();
            renderDays(currentMonthView, true);
            updateStreak();
            setupPWA();  // enable installability
        };
    })();
</script>
</body>
</html>